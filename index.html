<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWTCH App QR Code</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code generation library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Center the QR code canvas generated by the library */
        #qrcode canvas {
            display: block;
            margin: auto;
        }
        #qrcode img {
            display: block;
            margin: auto;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="main-content" class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg p-8 text-center">
        <header class="mb-6">
            <img src="https://assets-global.website-files.com/65a82424a459015849856a36/65a8257004353944a034f19b_SWTCH%20Logo.svg" alt="SWTCH Energy Logo" class="h-8 mx-auto mb-4">
            <h1 class="text-2xl font-bold text-gray-800">App Download</h1>
            <p class="text-gray-500 mt-2">Scan the QR code with your mobile device to download the SWTCH Install app.</p>
        </header>

        <!-- Container for the QR Code -->
        <div id="qrcode-container" class="my-8 flex justify-center">
            <div id="qrcode" class="p-4 bg-white border border-gray-200 rounded-lg inline-block"></div>
        </div>

        <footer class="mt-6">
            <p class="text-sm text-gray-500">
                Scanning will automatically open the correct app store for your device.
            </p>
            <!-- Fallback link for desktop users -->
            <p class="text-sm text-gray-500 mt-4">
                On a computer? <a id="fallback-link" href="#" class="text-blue-600 hover:underline">Continue to our website</a>.
            </p>
        </footer>
    </div>

    <script>
        // --- Configuration ---
        const config = {
            iosUrl: 'https://apps.apple.com/ca/app/swtch-install/id6740869501',
            androidUrl: 'https://play.google.com/store/apps/details?id=com.swtchenergy.cih&pcampaignid=web_share',
            fallbackUrl: 'https://swtchenergy.com/install/step-2/?token=714a191c3cef94d1d00b'
        };

        // --- Main Logic ---
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const shouldRedirect = urlParams.has('redirect');

            if (shouldRedirect) {
                // This logic runs ONLY when the QR code is scanned.
                handleRedirect();
            } else {
                // This logic runs when the page is loaded normally to display the QR code.
                displayQrCode();
            }
        });

        /**
         * Detects the user's operating system and redirects them to the appropriate URL.
         */
        function handleRedirect() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            const mainContent = document.getElementById('main-content');
            
            // Hide the main content and show a redirecting message
            if(mainContent) {
                mainContent.innerHTML = `
                    <h1 class="text-2xl font-bold text-gray-800">Redirecting...</h1>
                    <p class="text-gray-500 mt-2">Please wait while we take you to the correct app store.</p>
                `;
            }

            // iOS detection
            if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                window.location.replace(config.iosUrl);
            }
            // Android detection
            else if (/android/i.test(userAgent)) {
                window.location.replace(config.androidUrl);
            }
            // Fallback for desktops or other OS
            else {
                window.location.replace(config.fallbackUrl);
            }
        }

        /**
         * Generates and displays the QR code on the page.
         */
        function displayQrCode() {
            const qrCodeElement = document.getElementById('qrcode');
            const fallbackLink = document.getElementById('fallback-link');

            if (!qrCodeElement || !fallbackLink) {
                console.error("Required elements for QR code display are missing.");
                return;
            }

            // Set the fallback link href
            fallbackLink.href = config.fallbackUrl;

            // The URL the QR code will point to. It's the current page's URL with "?redirect=true" appended.
            // Using location.origin + location.pathname ensures we don't include existing query params.
            const redirectUrl = window.location.origin + window.location.pathname + '?redirect=true';

            // Generate the QR code
            new QRCode(qrCodeElement, {
                text: redirectUrl,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }
    </script>

</body>
</html>
